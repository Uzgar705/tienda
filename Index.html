<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor Pro</title>
    <style>
        /* ESTILO TIPO APP M√ìVIL */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; padding-bottom: 100px; }
        
        /* HEADER SUPERIOR */
        .header { background-color: #222; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tasa-container { background: #444; padding: 5px 10px; border-radius: 5px; display: flex; align-items: center; gap: 5px; border: 1px solid #666; }
        .tasa-input { background: transparent; border: none; color: #4cd137; font-weight: bold; font-size: 1.1em; width: 55px; text-align: center; outline: none; }
        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: none; outline: none; font-size: 16px; box-sizing: border-box; background: #fff; }

        /* LISTA DE PRODUCTOS */
        .container { padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; border-left: 5px solid transparent; transition: border-color 0.2s; }
        .card.selected { border-left-color: #0984e3; background-color: #f8fbff; }

        .card-top { display: flex; gap: 10px; }
        .img-box { width: 60px; height: 60px; background: #eee; border-radius: 8px; object-fit: cover; }
        .info { flex: 1; }
        .title { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 2px; }
        .price { color: #0984e3; font-weight: bold; font-size: 0.95em; }
        
        /* CONTROLES DE LA TARJETA */
        .card-actions { display: flex; gap: 10px; align-items: center; justify-content: flex-end; }
        .btn-icon { background: none; border: none; font-size: 1.3em; padding: 5px; cursor: pointer; }
        
        .card-controls { display: flex; align-items: center; justify-content: space-between; background: #f1f2f6; padding: 8px; border-radius: 8px; margin-top: 5px; }
        .qty-input { width: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 1.2em; font-weight: bold; background: white; }
        .row-total { font-size: 0.85em; text-align: right; color: #777; font-weight: bold; }
        .row-total.active { color: #009432; }

        /* BARRA INFERIOR (TOTALES) */
        .total-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; color: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .total-info { display: flex; flex-direction: column; }
        .gran-total-usd { font-size: 1.2em; font-weight: bold; color: #fff; }
        .gran-total-bs { font-size: 0.9em; color: #4cd137; }
        .btn-clean { background: #c0392b; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 0.8em; }

        /* BOT√ìN FLOTANTE (+) */
        .fab { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; background-color: #0984e3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1500; border: none; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 5px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-save { background: #0984e3; color: white; }
        .btn-cancel { background: #dfe6e9; color: #333; }
        
        h3 { margin: 0 0 5px 0; color: #333; }
    </style>
</head>
<body>

    <div class="header">
        <div class="top-row">
            <div style="font-weight: bold; font-size: 1.3em;">üõí Mi Tienda</div>
            <div class="tasa-container">
                <span>Bs.</span>
                <input type="number" id="tasaGlobal" class="tasa-input" value="40" oninput="guardarTasa(); recalcularTodo()">
            </div>
            <div style="font-size:1.5em; cursor:pointer;" onclick="menuExportar()">‚ãÆ</div>
            <input type="file" id="fileInput" style="display: none" onchange="importarDatos(this)">
        </div>
        <input type="text" id="buscador" class="search-box" placeholder="üîç Buscar producto..." oninput="renderizar()">
    </div>

    <div class="container" id="listaProductos"></div>

    <div class="total-bar">
        <div class="total-info">
            <span class="gran-total-usd" id="totalUsd">$0.00</span>
            <span class="gran-total-bs" id="totalBs">Bs. 0.00</span>
        </div>
        <button class="btn-clean" onclick="limpiarCantidades()">Limpiar Todo</button>
    </div>

    <button class="fab" onclick="abrirModal()">+</button>

    <div class="modal" id="modalProducto">
        <div class="modal-content">
            <h3 id="modalTitle">Nuevo Producto</h3>
            <input type="text" id="inpNombre" placeholder="Nombre del producto">
            <input type="number" id="inpPrecio" placeholder="Precio en D√≥lares ($)">
            <input type="text" id="inpImg" placeholder="URL de Imagen (Opcional)">
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-save" onclick="guardarProducto()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let productos = [];
        let cantidades = {}; // Aqu√≠ guardamos cu√°nto lleva el cliente de cada cosa { id: cantidad }
        let tasa = 40;
        let editandoIndex = -1; // -1 significa "Creando nuevo", otro n√∫mero es "Editando ese ID"

        // 1. INICIO
        window.onload = function() {
            cargarDatos();
            renderizar();
        };

        // 2. GUARDADO LOCAL
        function guardarDatos() {
            localStorage.setItem('mitienda_db', JSON.stringify(productos));
        }
        function guardarTasa() {
            tasa = document.getElementById('tasaGlobal').value;
            localStorage.setItem('mitienda_tasa', tasa);
        }
        function cargarDatos() {
            const db = localStorage.getItem('mitienda_db');
            const t = localStorage.getItem('mitienda_tasa');
            if (db) productos = JSON.parse(db);
            if (t) { tasa = t; document.getElementById('tasaGlobal').value = tasa; }
        }

        // 3. DIBUJAR PANTALLA
        function renderizar() {
            const filtro = document.getElementById('buscador').value.toLowerCase();
            const lista = document.getElementById('listaProductos');
            lista.innerHTML = '';

            // Asegurar que la tasa est√© actualizada
            tasa = parseFloat(document.getElementById('tasaGlobal').value) || 0;

            productos.forEach((p, index) => {
                if (p.nombre.toLowerCase().includes(filtro)) {
                    
                    const img = p.img ? p.img : 'https://via.placeholder.com/100?text=Foto';
                    // Recuperar cantidad si ya hab√≠a puesto algo
                    const cantActual = cantidades[index] || "";
                    const claseActiva = cantActual > 0 ? "selected" : "";

                    const html = `
                    <div class="card ${claseActiva}" id="card-${index}">
                        <div class="card-top">
                            <img src="${img}" class="img-box">
                            <div class="info">
                                <div class="title">${p.nombre}</div>
                                <div class="price">Precio: $${parseFloat(p.precio).toFixed(2)}</div>
                            </div>
                            <div class="card-actions">
                                <button class="btn-icon" onclick="editar(${index})" style="color:#f39c12">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="borrar(${index})" style="color:#e74c3c">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="card-controls">
                            <div style="font-weight:bold; color:#555;">Cant:</div>
                            <input type="number" class="qty-input" value="${cantActual}" placeholder="0" 
                                   oninput="actualizarCalculo(${index}, this.value, ${p.precio})">
                            <div class="row-total" id="res-${index}">
                                $0.00<br>Bs. 0.00
                            </div>
                        </div>
                    </div>
                    `;
                    lista.innerHTML += html;
                    
                    // Si hab√≠a cantidad, calcular visualmente de una vez
                    if(cantActual > 0) actualizarFila(index, cantActual, p.precio);
                }
            });
            calcularTotalGeneral();
        }

        // 4. C√ÅLCULOS INDIVIDUALES Y TOTALES
        function actualizarCalculo(index, cantidadVal, precio) {
            const cantidad = parseFloat(cantidadVal) || 0;
            cantidades[index] = cantidad; // Guardar en memoria del "carrito"
            
            // Cambiar color de la tarjeta si est√° seleccionada
            const card = document.getElementById(`card-${index}`);
            if(cantidad > 0) card.classList.add('selected');
            else card.classList.remove('selected');

            actualizarFila(index, cantidad, precio);
            calcularTotalGeneral();
        }

        function actualizarFila(index, cantidad, precio) {
            const divRes = document.getElementById(`res-${index}`);
            if (!divRes) return; // Por si filtramos y no est√° visible

            const tUsd = cantidad * precio;
            const tBs = tUsd * tasa;

            divRes.innerHTML = `$${tUsd.toFixed(2)}<br>Bs. ${tBs.toLocaleString('es-VE', {minimumFractionDigits: 2})}`;
            
            if (cantidad > 0) divRes.classList.add('active');
            else divRes.classList.remove('active');
        }

        function calcularTotalGeneral() {
            let granTotalUsd = 0;
            
            // Recorrer el objeto de cantidades
            for (const [index, cant] of Object.entries(cantidades)) {
                if (productos[index]) {
                    granTotalUsd += cant * parseFloat(productos[index].precio);
                }
            }
            
            const granTotalBs = granTotalUsd * tasa;

            document.getElementById('totalUsd').innerText = `$${granTotalUsd.toFixed(2)}`;
            document.getElementById('totalBs').innerText = `Bs. ${granTotalBs.toLocaleString('es-VE', {minimumFractionDigits: 2})}`;
        }

        function limpiarCantidades() {
            if(confirm("¬øVaciar el carrito de compras?")) {
                cantidades = {};
                renderizar();
            }
        }

        // 5. ABM (AGREGAR, BORRAR, MODIFICAR)
        function abrirModal() {
            editandoIndex = -1; // Modo crear
            document.getElementById('modalTitle').innerText = "Nuevo Producto";
            document.getElementById('inpNombre').value = "";
            document.getElementById('inpPrecio').value = "";
            document.getElementById('inpImg').value = "";
            document.getElementById('modalProducto').style.display = 'flex';
        }

        function editar(index) {
            editandoIndex = index; // Modo editar
            const p = productos[index];
            document.getElementById('modalTitle').innerText = "Editar Producto";
            document.getElementById('inpNombre').value = p.nombre;
            document.getElementById('inpPrecio').value = p.precio;
            document.getElementById('inpImg').value = p.img;
            document.getElementById('modalProducto').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalProducto').style.display = 'none';
        }

        function guardarProducto() {
            const nombre = document.getElementById('inpNombre').value;
            const precio = parseFloat(document.getElementById('inpPrecio').value);
            const img = document.getElementById('inpImg').value;

            if (!nombre || isNaN(precio)) {
                alert("Falta nombre o precio");
                return;
            }

            if (editandoIndex === -1) {
                // CREAR NUEVO
                productos.push({ nombre, precio, img });
            } else {
                // ACTUALIZAR EXISTENTE
                productos[editandoIndex] = { nombre, precio, img };
            }

            guardarDatos();
            cerrarModal();
            renderizar();
        }

        function borrar(index) {
            if (confirm("¬øEliminar este producto permanentemente?")) {
                productos.splice(index, 1);
                delete cantidades[index]; // Quitar del carrito si estaba
                guardarDatos();
                renderizar();
            }
        }

        function recalcularTodo() {
            renderizar(); // Vuelve a pintar todo con la nueva tasa
        }

        // 6. EXPORTAR / IMPORTAR
        function menuExportar() {
            const opcion = prompt("Escribe:\n1 para Exportar lista\n2 para Importar lista");
            if (opcion === "1") {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productos));
                const node = document.createElement('a');
                node.href = dataStr;
                node.download = "productos_tienda.json";
                node.click();
            } else if (opcion === "2") {
                document.getElementById('fileInput').click();
            }
        }

        function importarDatos(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    productos = JSON.parse(e.target.result);
                    guardarDatos();
                    renderizar();
                    alert("¬°Datos cargados!");
                } catch(e) { alert("Error en el archivo"); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>